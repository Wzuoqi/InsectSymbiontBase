{% extends "base.html" %}

{% block Part1 %}

{% comment %} Introduction Section {% endcomment %}
<section class="container px-4 mx-auto mt-10">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-12">
        <div class="flex-1">
            <h1 class="text-4xl font-bold text-kabuli-900 dark:text-white mb-4">Functional Symbiont Records</h1>
            <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed max-w-4xl">
                A comprehensive collection of verified insect-symbiont relationships curated from 9000+ scientific literature.
                Our database currently contains <span class="font-semibold text-kabuli-700">{{ page_obj.paginator.count }}</span> records spanning multiple insect orders
                and their associated microbial partners. We also organized the functional records into three main categories, with 20 subcategories, to facilitate future insect
                symbiont research.
            </p>
        </div>
        <div class="flex-none">
            <div class="inline-flex items-center justify-center p-6 bg-kabuli-50 dark:bg-gray-800 rounded-2xl">
                <div class="text-center">
                    <span class="block text-3xl font-bold text-kabuli-700 dark:text-kabuli-400">2,625</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">Total Records</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
        <!-- Left Chart: Distribution -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-100 dark:border-gray-700">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-white">Symbiont Distribution</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">By classification and symbiont phylum</p>
                </div>
            </div>
            <div class="h-80" id="distributionChart"></div>
        </div>

        <!-- Right Chart: Functions Overview -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-100 dark:border-gray-700">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-white">Functions Overview</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Categories of symbiont functions</p>
                </div>
            </div>
            <div class="h-80" id="functionsChart"></div>
        </div>
    </div>
</section>

{% comment %} Symbionts Table {% endcomment %}
<section class="container px-4 mx-auto mt-10">
    {% load static %}
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <div class="flex items-center gap-x-3">
                <h2 class="text-xl font-bold text-kabuli-800 dark:text-white">Functional Symbionts</h2>
                <span class="px-3 py-1 text-xs text-kabuli-600 bg-kabuli-100 rounded-full dark:bg-gray-800 dark:text-kabuli-400">{{ page_obj.paginator.count }} records</span>
            </div>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">Records of insect symbionts with verified function from literatures.</p>
        </div>

        <div class="flex items-center mt-4 gap-x-3">
            <!-- 新增清除筛选按钮 -->
            {% if query or filter_type or search_params != '{}' %}
            <a href="{% url 'symbiont:symbionts' %}"
               class="flex items-center justify-center px-5 py-2 text-sm tracking-wide text-gray-700 transition-colors duration-200 bg-white border rounded-lg gap-x-2 hover:bg-gray-100 dark:hover:bg-gray-800 dark:bg-gray-900 dark:text-gray-200 dark:border-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                <span>Reset</span>
            </a>
            {% endif %}

            <button id="advanceSearchBtn" class="flex items-center justify-center w-1/2 px-5 py-2 text-sm tracking-wide text-white transition-colors duration-200 bg-kabuli-800 rounded-lg shrink-0 sm:w-auto gap-x-2 hover:bg-kabuli-600 dark:hover:bg-kabuli-500 dark:bg-kabuli-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Advance Search</span>
            </button>
        </div>
    </div>

    <div class="mt-6 md:flex md:items-center md:justify-between">
        <div class="inline-flex overflow-hidden bg-white border divide-x rounded-lg dark:bg-gray-900 rtl:flex-row-reverse dark:border-gray-700 dark:divide-gray-700">
            <a href="?filter=all{% if query %}&q={{ query }}{% endif %}"
               class="px-5 py-2 text-xs font-medium text-gray-600 transition-colors duration-200 {% if filter_type == 'all' or not filter_type %}bg-gray-100{% endif %} sm:text-sm dark:bg-gray-800 dark:text-gray-300 hover:bg-gray-100"
               data-tippy-content="Show all records">
                View all
            </a>

            <a href="?filter=bacteria{% if query %}&q={{ query }}{% endif %}"
               class="px-5 py-2 text-xs font-medium text-gray-600 transition-colors duration-200 {% if filter_type == 'bacteria' %}bg-gray-100{% endif %} sm:text-sm dark:hover:bg-gray-800 dark:text-gray-300 hover:bg-gray-100"
               data-tippy-content="Show only bacterial symbionts">
                Bacteria
            </a>

            <a href="?filter=fungi{% if query %}&q={{ query }}{% endif %}"
               class="px-5 py-2 text-xs font-medium text-gray-600 transition-colors duration-200 {% if filter_type == 'fungi' %}bg-gray-100{% endif %} sm:text-sm dark:hover:bg-gray-800 dark:text-gray-300 hover:bg-gray-100"
               data-tippy-content="Show only fungal symbionts">
                Fungi
            </a>
        </div>

        <!-- 在 head 部分添加 jQuery UI 的 CSS 和 JS -->
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

        <!-- 修改搜索框部分 -->
        <div class="relative flex items-center mt-4 md:mt-0">
            <span class="absolute">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mx-3 text-gray-400 dark:text-gray-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
            </span>

            <form action="" method="get" class="w-full">
                <input type="text"
                       name="q"
                       id="search-input"
                       value="{{ query|default:'' }}"
                       placeholder="Search"
                       class="block w-full py-1.5 pr-5 text-gray-700 bg-white border border-gray-200 rounded-lg md:w-80 placeholder-gray-400/70 pl-11 rtl:pr-11 rtl:pl-5 dark:bg-gray-900 dark:text-gray-300 dark:border-gray-600 focus:border-kabuli-400 dark:focus:border-kabuli-300 focus:ring-kabuli-300 focus:outline-none focus:ring focus:ring-opacity-40">
            </form>
        </div>

        <!-- 添加自动补全的 JavaScript -->
        <script>
        $(document).ready(function() {
            $("#search-input").autocomplete({
                source: "{% url 'symbiont:autocomplete' %}",
                minLength: 2,
                select: function(event, ui) {
                    // 当用户选择一个建议时，移除前缀并提交表单
                    const value = ui.item.value.replace(/^(Symbiont: |Host: |Function: |Phylum: )/, '');
                    $(this).val(value);
                    $(this).closest('form').submit();
                    return false;
                }
            }).data("ui-autocomplete")._renderItem = function(ul, item) {
                // 自定义建议项的渲染
                const value = item.value;
                const prefix = value.split(': ')[0];
                const content = value.split(': ')[1];

                return $("<li>")
                    .append(`<div class='flex items-center p-2'>
                                <span class='text-xs text-kabuli-600 mr-2'>${prefix}:</span>
                                <span class='text-gray-700'>${content}</span>
                            </div>`)
                    .appendTo(ul);
            };

            // 自定义样式
            $(".ui-autocomplete").addClass("bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg");
        });
        </script>
    </div>

    {% comment %} Symbionts Table {% endcomment %}
    <div class="flex flex-col mt-6">
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                <div class="overflow-hidden border border-gray-200 dark:border-gray-700 md:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="py-3.5 px-4 text-sm font-bold text-center rtl:text-right text-gray-800 dark:text-gray-600">
                                    <button class="flex items-center gap-x-3 focus:outline-none" onclick="sortTable('symbiont_name')">
                                        <span>Symbiont</span>
                                        <svg class="h-3 {% if current_order == 'symbiont_name' %}text-kabuli-500{% elif current_order == '-symbiont_name' %}text-kabuli-500 transform rotate-180{% else %}text-gray-400{% endif %}" viewBox="0 0 10 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M2.13347 0.0999756H2.98516L5.01902 4.79058H3.86226L3.45549 3.79907H1.63772L1.24366 4.79058H0.0996094L2.13347 0.0999756ZM2.54025 1.46012L1.96822 2.92196H3.11227L2.54025 1.46012Z" fill="currentColor" stroke="currentColor" stroke-width="0.1" />
                                            <path d="M0.722656 9.60832L3.09974 6.78633H0.811638V5.87109H4.35819V6.78633L2.01925 9.60832H4.43446V10.5617H0.722656V9.60832Z" fill="currentColor" stroke="currentColor" stroke-width="0.1" />
                                            <path d="M8.45558 7.25664V7.40664H8.60558H9.66065C9.72481 7.40664 9.74667 7.42274 9.75141 7.42691C9.75148 7.42808 9.75146 7.42993 9.75116 7.43262C9.75001 7.44265 9.74458 7.46304 9.72525 7.49314C9.72522 7.4932 9.72518 7.49326 9.72514 7.49332L7.86959 10.3529L7.86924 10.3534C7.83227 10.4109 7.79863 10.418 7.78568 10.418C7.77272 10.418 7.73908 10.4109 7.70211 10.3534L7.70177 10.3529L5.84621 7.49332C5.84617 7.49325 5.84612 7.49318 5.84608 7.49311C5.82677 7.46302 5.82135 7.44264 5.8202 7.43262C5.81989 7.42993 5.81987 7.42808 5.81994 7.42691C5.82469 7.42274 5.84655 7.40664 5.91071 7.40664H6.96578H7.11578V7.25664V0.633865C7.11578 0.42434 7.29014 0.249976 7.49967 0.249976H8.07169C8.28121 0.249976 8.45558 0.42434 8.45558 0.633865V7.25664Z" fill="currentColor" stroke="currentColor" stroke-width="0.3" />
                                        </svg>
                                    </button>
                                </th>

                                <th scope="col" class="px-4 py-3.5 text-sm font-normal text-left rtl:text-right text-gray-500 dark:text-gray-400">
                                    Host Insect
                                </th>

                                <th scope="col" class="px-4 py-3.5 text-sm font-normal text-center rtl:text-right text-gray-500 dark:text-gray-400">
                                    Classification
                                </th>

                                <th scope="col" class="px-4 py-3.5 text-sm font-normal text-center rtl:text-right text-gray-500 dark:text-gray-400">
                                    Function
                                </th>

                                <th scope="col" class="px-4 py-3.5 text-sm font-normal text-center rtl:text-right text-gray-500 dark:text-gray-400">
                                    Function Tags
                                </th>

                                <th scope="col" class="px-4 py-3.5 text-sm font-normal text-center rtl:text-right text-gray-500 dark:text-gray-400">
                                    Year
                                </th>

                                <th scope="col" class="relative py-3.5 px-4">
                                    <span class="sr-only">Edit</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 dark:divide-gray-700 dark:bg-gray-900">
                            {% for symbiont in page_obj %}
                            <tr>
                                <td class="px-4 py-4 text-sm font-medium whitespace-nowrap">
                                    {% if symbiont.symbiont_name and symbiont.symbiont_name != "NA" %}
                                    <div>
                                        <a href="{% url 'symbiont:symbiont_detail' symbiont.id %}" class="font-medium text-kabuli-800 dark:text-kabuli-400 hover:underline">
                                            {{ symbiont.symbiont_name }}
                                        </a>
                                        {% if symbiont.symbiont_phylum and symbiont.symbiont_phylum != "NA" %}
                                        <p class="text-xs font-normal text-gray-600 dark:text-gray-400">{{ symbiont.symbiont_phylum }}</p>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-sm font-medium whitespace-nowrap">
                                    <div>
                                        {% if symbiont.host_species and symbiont.host_species != "NA" %}
                                        <h2 class="italic font-medium text-gray-900 dark:text-white">
                                            <a href="/hosts/species/{{ symbiont.host_species|urlencode }}/"
                                               class="hover:text-kabuli-600 dark:hover:text-kabuli-400 transition-colors duration-200"
                                               title="View details for {{ symbiont.host_species }}">
                                                {{ symbiont.host_species }}
                                            </a>
                                        </h2>
                                        {% endif %}
                                        {% if symbiont.host_order and symbiont.host_order != "NA" %}
                                        <p class="text-xs font-normal text-gray-600 dark:text-gray-400">{{ symbiont.host_order }}</p>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-sm font-medium whitespace-nowrap">
                                    {% if symbiont.classification and symbiont.classification != "NA" %}
                                    <div class="inline px-3 py-1 text-sm font-normal rounded-full gap-x-2
                                        {% if symbiont.classification == 'Bacteria' %}
                                            bg-orange-100 text-orange-800
                                        {% elif symbiont.classification == 'Fungi' %}
                                            bg-emerald-100 text-emerald-800
                                        {% elif symbiont.classification == 'Bacteria and Fungi' %}
                                            bg-purple-100 text-purple-800
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}
                                    ">
                                        {{ symbiont.classification }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-sm font-medium whitespace-normal break-words max-w-sm">
                                    {% if symbiont.function and symbiont.function != "NA" %}
                                    <div>
                                        <p class="text-gray-700 dark:text-gray-400">{{ symbiont.function }}</p>
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-sm font-medium whitespace-normal break-words max-w-sm">
                                    {% if symbiont.function_tags %}
                                    <div class="flex flex-wrap gap-2">
                                        {% for tag in symbiont.function_tags %}
                                            <a href="?function_tag={{ tag.text|urlencode }}"
                                               class="px-2 py-1 text-sm font-medium rounded-full whitespace-nowrap {{ tag.color_class }} hover:opacity-80 transition-opacity cursor-pointer"
                                               title="Search records with {{ tag.text }} function">
                                                {{ tag.text }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-sm whitespace-nowrap">
                                    {% if symbiont.year and symbiont.year != "NA" %}
                                    <div>
                                        <h4 class="text-gray-700 text-center dark:text-gray-200">{{ symbiont.year }}</h4>
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-sm whitespace-nowrap">
                                    <div class="flex items-center justify-center space-x-2">
                                        {% if symbiont.doi and symbiont.doi != "NA" %}
                                        <a href="https://doi.org/{{symbiont.doi}}" target="_blank"
                                            class="text-gray-500 transition-colors duration-200 hover:text-gray-900 dark:text-gray-300 dark:hover:text-gray-100">
                                            <i class="fa-solid fa-book-bookmark"></i>
                                        </a>
                                        {% endif %}

                                        <a href="{% url 'symbiont:symbiont_detail' symbiont.id %}"
                                           class="text-gray-500 transition-colors duration-200 hover:text-kabuli-600 dark:text-gray-300 dark:hover:text-kabuli-400"
                                           title="show details">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-6 sm:flex sm:items-center sm:justify-between ">
        <div class="text-sm text-gray-500 dark:text-gray-400">
            Page <span class="font-medium text-gray-700 dark:text-gray-100">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </div>

        <div class="flex items-center mt-4 gap-x-4 sm:mt-0">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&{{ query_string }}"
               class="flex items-center justify-center w-1/2 px-5 py-2 text-sm text-gray-700 capitalize transition-colors duration-200 bg-white border rounded-md sm:w-auto gap-x-2 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 rtl:-scale-x-100">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 15.75L3 12m0 0l3.75-3.75M3 12h18" />
                </svg>
                <span>Previous</span>
            </a>
            {% endif %}

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&{{ query_string }}"
               class="flex items-center justify-center w-1/2 px-5 py-2 text-sm text-gray-700 capitalize transition-colors duration-200 bg-white border rounded-md sm:w-auto gap-x-2 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-800">
                <span>Next</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 rtl:-scale-x-100">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" />
                </svg>
            </a>
            {% endif %}
        </div>
    </div>

    <div id="advanceSearchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3">
                <h3 class="text-2xl leading-6 font-medium text-gray-900 dark:text-white mb-4 text-center">Advanced Search</h3>
                <form id="advanceSearchForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Host Information Section -->
                        <div class="md:col-span-2">
                            <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Host Information</h4>
                        </div>
                        <div>
                            <label for="host_order" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Host Order</label>
                            <input type="text" id="host_order" name="host_order" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="host_family" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Host Family</label>
                            <input type="text" id="host_family" name="host_family" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="host_species" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Host Species</label>
                            <input type="text" id="host_species" name="host_species" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <!-- Symbiont Information Section -->
                        <div class="md:col-span-2 mt-4">
                            <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Symbiont Information</h4>
                        </div>
                        <div>
                            <label for="symbiont_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Symbiont Name</label>
                            <input type="text" id="symbiont_name" name="symbiont_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="symbiont_phylum" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Symbiont Phylum</label>
                            <input type="text" id="symbiont_phylum" name="symbiont_phylum" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="symbiont_order" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Symbiont Order</label>
                            <input type="text" id="symbiont_order" name="symbiont_order" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="symbiont_genus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Symbiont Genus</label>
                            <input type="text" id="symbiont_genus" name="symbiont_genus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <!-- Function Information Section -->
                        <div class="md:col-span-2 mt-4">
                            <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Function Information</h4>
                        </div>
                        <div>
                            <label for="classification" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Classification</label>
                            <input type="text" id="classification" name="classification" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="function" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Function</label>
                            <input type="text" id="function" name="function" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="function_tag" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Function Tags</label>
                            <input type="text" id="function_tag" name="function_tag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label for="year" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Year</label>
                            <input type="number" id="year" name="year" min="1900" max="2100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <!-- Genome ID Section -->
                        <div class="md:col-span-2 mt-4">
                            <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Genome ID</h4>
                        </div>
                        <div>
                            <label for="genome_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Genome ID</label>
                            <input type="text" id="genome_id" name="genome_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-kabuli-500 focus:ring focus:ring-kabuli-500 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="advanceSearchCloseBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-kabuli-600 rounded-md hover:bg-kabuli-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kabuli-500">
                            Search
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- 在页面底部添加以下脚本 -->
<script>
    // 简化的 ECharts 加载函数
    function loadECharts() {
        return new Promise((resolve, reject) => {
            if (window.echarts) {
                resolve(window.echarts);
                return;
            }

            const script = document.createElement('script');
            script.src = '/static/js/echarts.min.js';  // 直接使用本地文件
            script.onload = () => resolve(window.echarts);
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // 声明全局变量来存储图表实例
    let distributionChart = null;
    let functionsChart = null;

    // 初始化图表的函数
    async function initCharts() {
        try {
            const echarts = await loadECharts();
            const darkMode = document.documentElement.classList.contains('dark');
            const textColor = darkMode ? '#e5e7eb' : '#374151';
            const backgroundColor = darkMode ? '#1f2937' : '#ffffff';

            // Distribution Chart
            const distributionContainer = document.getElementById('distributionChart');
            if (distributionContainer) {
                distributionChart = echarts.init(distributionContainer);
                const distributionOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{b}: {c}'
                    },
                    series: [{
                        type: 'treemap',
                        data: [
                            {
                                name: 'Bacteria',
                                value: 2130,
                                children: [
                                    { name: 'Pseudomonadota', value: 1554 },
                                    { name: 'Mycoplasmatota', value: 51 },
                                    { name: 'Bacillota', value: 310 },
                                    { name: 'Actinomycetota', value: 104 },
                                    { name: 'Bacteroidota', value: 96 },
                                    { name: 'Spirochaetota', value: 4 },

                                ]
                            },
                            {
                                name: 'Fungi',
                                value: 253,
                                children: [
                                    { name: 'Ascomycota', value: 201 },
                                    { name: 'Basidiomycota', value: 38 },
                                    { name: 'Microsporidia', value: 4 },
                                    { name: 'Mucoromycota', value: 5 },
                                    { name: 'Zoopagomycota', value: 5 },
                                ]
                            },
                            {
                                name: 'Others',
                                value: 230,
                                children: [
                                    { name: 'Others', value: 230 },

                                ]
                            }
                        ],
                        label: {
                            show: true,
                            formatter: '{b}',
                            fontSize: 12
                        },
                        breadcrumb: {
                            show: false
                        },
                        itemStyle: {
                            borderRadius: 4,
                            borderWidth: 2,
                            gapWidth: 4
                        },
                        levels: [{
                            itemStyle: {
                                borderColor: backgroundColor,
                                borderWidth: 2,
                                gapWidth: 4
                            }
                        }]
                    }]
                };
                distributionChart.setOption(distributionOption);
            }

            // Functions Chart
            const functionsContainer = document.getElementById('functionsChart');
            if (functionsContainer) {
                functionsChart = echarts.init(functionsContainer);
                const functionsOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: (params) => {
                            const fullNames = {
                                'N-fixation': 'Nitrogen fixation',
                                'Feeding': 'Feeding habits',
                                'Nutrients': 'Nutrient provision',
                                'Digest': 'Digestive enzymes',
                                'Plastic': 'Plastic degradation',
                                'Farming': 'Fungal farming',
                                'Sugar': 'Sugar metabolism',
                                'Plant def.': 'Plant defense',
                                'Pesticide': 'Pesticide metabolization',
                                'Immunity': 'Immune priming',
                                'Antimicro.': 'Antimicrobials',
                                'Plant sec.': 'Plant secondary metabolites',
                                'Resistance': 'Natural enemy resistance',
                                'Pathogen': 'Pathogen interaction',
                                'Chemical': 'Chemical biosynthesis',
                                'Growth': 'Growth and Development',
                                'Pigment': 'Pigmentation alteration',
                                'Reproduce': 'Reproductive manipulation'
                            };
                            const displayName = fullNames[params.name] || params.name;
                            return `${displayName}: ${params.value || ''}`;
                        }
                    },
                    series: [{
                        type: 'sunburst',
                        radius: ['15%', '95%'],
                        emphasis: {
                            focus: 'ancestor'
                        },
                        data: [{
                            name: 'Nutrition',
                            value: 736,
                            itemStyle: { color: '#2dd4bf' },
                            label: {
                                show: false,
                                fontSize: 12,
                                rotate: 'tangential',
                                align: 'center',
                                distance: 5,
                                padding: [3, 4, 3, 4]
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 12,
                                    rotate: 'tangential',
                                    align: 'center',
                                    distance: 5
                                }
                            },
                            children: [
                                {
                                    name: 'N-fixation',
                                    value: 55,
                                    itemStyle: { color: '#14b8a6' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Feeding',
                                    value: 4,
                                    itemStyle: { color: '#0d9488' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Probiotic',
                                    value: 9,
                                    itemStyle: { color: '#0f766e' },
                                    label: {
                                        show: false
                                    }
                                },
                                {
                                    name: 'Nutrients',
                                    value: 314,
                                    itemStyle: { color: '#115e59' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Digest',
                                    value: 287,
                                    itemStyle: { color: '#134e4a' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Plastic',
                                    value: 31,
                                    itemStyle: { color: '#042f2e' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Farming',
                                    value: 17,
                                    itemStyle: { color: '#2dd4bf' },
                                    label: {
                                        show: false
                                    }
                                },
                                {
                                    name: 'Sugar',
                                    value: 19,
                                    itemStyle: { color: '#99f6e4' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                }
                            ]
                        }, {
                            name: 'Defense',
                            value: 642,
                            itemStyle: { color: '#f59e0b' },
                            label: {
                                show: false,
                                fontSize: 12,
                                rotate: 'tangential',
                                align: 'center',
                                distance: 5,
                                padding: [3, 4, 3, 4]
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 12,
                                    rotate: 'tangential',
                                    align: 'center',
                                    distance: 5
                                }
                            },
                            children: [
                                {
                                    name: 'Plant def.',
                                    value: 62,
                                    itemStyle: { color: '#d97706' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Pesticide',
                                    value: 101,
                                    itemStyle: { color: '#b45309' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Immunity',
                                    value: 46,
                                    itemStyle: { color: '#92400e' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Antimicro.',
                                    value: 113,
                                    itemStyle: { color: '#78350f' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Plant sec.',
                                    value: 142,
                                    itemStyle: { color: '#fbbf24' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Resistance',
                                    value: 46,
                                    itemStyle: { color: '#f59e0b' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Pathogen',
                                    value: 70,
                                    itemStyle: { color: '#fcd34d' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Chemical',
                                    value: 62,
                                    itemStyle: { color: '#fde68a' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                }
                            ]
                        }, {
                            name: 'Physiology',
                            value: 349,
                            itemStyle: { color: '#8b5cf6' },
                            label: {
                                show: false,
                                fontSize: 12,
                                rotate: 'tangential',
                                align: 'center',
                                distance: 5,
                                padding: [3, 4, 3, 4]
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 12,
                                    rotate: 'tangential',
                                    align: 'center',
                                    distance: 5
                                }
                            },
                            children: [
                                {
                                    name: 'Growth',
                                    value: 162,
                                    itemStyle: { color: '#7c3aed' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Fertility',
                                    value: 68,
                                    itemStyle: { color: '#6d28d9' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Pigment',
                                    value: 5,
                                    itemStyle: { color: '#5b21b6' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                },
                                {
                                    name: 'Reproduce',
                                    value: 114,
                                    itemStyle: { color: '#4c1d95' },
                                    label: {
                                        fontSize: 9,
                                        rotate: 'radial',
                                        align: 'right'
                                    }
                                }
                            ]
                        }],
                        levels: [{
                            // 内层配置（主分类）
                            r0: '15%',
                            r: '40%',
                            itemStyle: {
                                borderWidth: 2,
                                borderColor: backgroundColor
                            },
                            label: {
                                show: false,
                                rotate: 'tangential',
                                fontSize: 12,
                                fontWeight: 'bold',
                                align: 'center',
                                distance: 5,
                                padding: [3, 4, 3, 4],
                                position: 'inside'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 12,
                                    rotate: 'tangential',
                                    align: 'center',
                                    distance: 5
                                }
                            }
                        }, {
                            // 外层配置（子分类）
                            r0: '40%',
                            r: '95%',
                            label: {
                                show: true,
                                rotate: 'radial',
                                fontSize: 9,
                                padding: 2,
                                align: 'right'
                            }
                        }]
                    }]
                };
                functionsChart.setOption(functionsOption);
            }

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                if (distributionChart) {
                    distributionChart.resize();
                }
                if (functionsChart) {
                    functionsChart.resize();
                }
            });

        } catch (error) {
            console.error('Failed to initialize charts:', error);
            const chartContainers = document.querySelectorAll('#distributionChart, #functionsChart');
            chartContainers.forEach(container => {
                container.innerHTML = '<div class="text-center p-4 text-gray-500">Failed to load chart. Please refresh the page.</div>';
            });
        }
    }

    // 确保在 DOM 加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCharts);
    } else {
        initCharts();
    }
</script>

<!-- 添加JavaScript控制模态框 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const advanceSearchBtn = document.getElementById('advanceSearchBtn');
        const advanceSearchModal = document.getElementById('advanceSearchModal');
        const advanceSearchCloseBtn = document.getElementById('advanceSearchCloseBtn');
        const advanceSearchForm = document.getElementById('advanceSearchForm');

        // 打开模态框
        advanceSearchBtn.addEventListener('click', function() {
            advanceSearchModal.classList.remove('hidden');
        });

        // 关闭模态框
        advanceSearchCloseBtn.addEventListener('click', function() {
            advanceSearchModal.classList.add('hidden');
        });

        // 点击模态框外部关闭
        advanceSearchModal.addEventListener('click', function(e) {
            if (e.target === advanceSearchModal) {
                advanceSearchModal.classList.add('hidden');
            }
        });

        // 处理表单提交
        advanceSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(advanceSearchForm);
            const searchParams = new URLSearchParams();

            // 只添加非空的参数
            for (const [key, value] of formData.entries()) {
                if (value.trim()) {
                    searchParams.append(key, value.trim());
                }
            }

            // 重定向到带有搜索参数的URL
            window.location.href = `${window.location.pathname}?${searchParams.toString()}`;
        });

        // 如果存在搜索参数，填充表单
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams.entries()) {
            const input = document.getElementById(key);
            if (input) {
                input.value = value;
            }
        }
    });
</script>

<!-- 在页面底部添加排序函数 -->
<script>
function sortTable(field) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentOrder = urlParams.get('order');

    // 确定新的排序方向
    let newOrder;
    if (!currentOrder || currentOrder === 'id') {
        // 从默认排序切换到正序
        newOrder = field;
    } else if (currentOrder === field) {
        // 从正序切换到倒序
        newOrder = `-${field}`;
    } else if (currentOrder === `-${field}`) {
        // 从倒序切换回默认排序
        newOrder = 'id';
    } else {
        // 其他情况，切换到正序
        newOrder = field;
    }

    // 更新URL参数
    urlParams.set('order', newOrder);

    // 保持其他搜索参数不变
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    window.location.href = newUrl;
}
</script>

<!-- 添加悬浮返回首页按钮 -->
<div class="fixed bottom-16 right-8 z-50">
    <a href="{% url 'home' %}"
       class="flex items-center justify-center w-12 h-12 rounded-full bg-kabuli-700 hover:bg-kabuli-800 text-white shadow-lg transition-all duration-300 hover:scale-110"
       title="Return to Homepage">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
    </a>
</div>

{% endblock %}